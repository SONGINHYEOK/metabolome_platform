{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}특용작물 대사체 통합 디지털 플랫폼{% endblock %}</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'navy': '#1a1f36',
              'navy-light': '#2d3348',
              'accent': '#2563eb',
              'accent-light': '#3b82f6',
            },
            fontSize: {
              'display': ['3.25rem', { lineHeight: '1.2' }],
              'heading': ['2.25rem', { lineHeight: '1.3' }],
              'subheading': ['1.5rem', { lineHeight: '1.4' }],
              'body-lg': ['1.375rem', { lineHeight: '1.6' }],
            }
          }
        }
      }
    </script>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        html {
            font-size: 112.5%; /* 18px base (default 16px) — 전체 글씨 크기 확대 */
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Noto Sans KR', 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Disabled button cursor */
        button[disabled], .disabled { cursor: not-allowed; }

        /* Transition defaults */
        select, input, button, a { transition: all 0.15s ease; }

        /* Tabular numbers for scores */
        .tabular-nums { font-variant-numeric: tabular-nums; }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1a1f36;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            z-index: 9999;
            opacity: 0;
            transition: all 0.3s ease;
            pointer-events: none;
        }
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Chatbot widget */
        .chatbot-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.4);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .chatbot-btn:hover {
            background: #1d4ed8;
            transform: scale(1.05);
        }
        .chatbot-panel {
            position: fixed;
            bottom: 92px;
            right: 24px;
            width: 380px;
            height: 520px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 10000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .chatbot-panel.open { display: flex; }
        .chatbot-header {
            background: #1a1f36;
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .chat-msg {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.5;
            word-break: break-word;
        }
        .chat-msg.user {
            align-self: flex-end;
            background: #2563eb;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-msg.assistant {
            align-self: flex-start;
            background: #f1f5f9;
            color: #1e293b;
            border-bottom-left-radius: 4px;
        }
        .chat-msg.error {
            align-self: flex-start;
            background: #fef2f2;
            color: #991b1b;
            border-bottom-left-radius: 4px;
        }
        .chat-msg.loading {
            align-self: flex-start;
            background: #f1f5f9;
            color: #64748b;
        }
        .chatbot-input-area {
            padding: 12px 16px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 8px;
        }
        .chatbot-input-area input {
            flex: 1;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 13px;
            outline: none;
        }
        .chatbot-input-area input:focus { border-color: #2563eb; }
        .chatbot-input-area button {
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }
        .chatbot-input-area button:hover { background: #1d4ed8; }
        .chatbot-input-area button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
    </style>
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-gray-50 text-gray-900">
    {% block content %}{% endblock %}

    <!-- Global Toast -->
    <div class="toast" id="globalToast"></div>

    <!-- ===== Chatbot Widget ===== -->
    <button class="chatbot-btn" onclick="toggleChatbot()" title="AI 어시스턴트">
        <svg id="chatbotIconOpen" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
        </svg>
        <svg id="chatbotIconClose" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display:none">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
    </button>

    <div class="chatbot-panel" id="chatbotPanel">
        <div class="chatbot-header">
            <div>
                <div style="font-weight:700;font-size:14px;">AI 어시스턴트</div>
                <div style="font-size:11px;opacity:0.7;">대사체 플랫폼 전문 AI</div>
            </div>
            <button onclick="toggleChatbot()" style="background:none;border:none;color:white;cursor:pointer;padding:4px;">
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="chatbot-messages" id="chatbotMessages">
            <div class="chat-msg assistant">
                안녕하세요! 특용작물 대사체 플랫폼 AI 어시스턴트입니다. 성분, 작물, 분석 결과에 대해 질문해 주세요.
            </div>
        </div>
        <div class="chatbot-input-area">
            <input type="text" id="chatbotInput" placeholder="메시지를 입력하세요..." onkeydown="if(event.key==='Enter')sendChatMessage()">
            <button onclick="sendChatMessage()" id="chatbotSendBtn">전송</button>
        </div>
    </div>

    <!-- Global JS: Search bar & disabled element handling -->
    <script>
    function showToast(msg) {
        var t = document.getElementById('globalToast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(function() { t.classList.remove('show'); }, 2000);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Search bars: show toast on Enter
        document.querySelectorAll('input[placeholder*="Search"], input[placeholder*="검색"], input[placeholder*="탐색"]').forEach(function(el) {
            el.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    showToast('검색 기능은 개발 예정입니다');
                }
            });
        });

        // Placeholder links (#): show toast on click
        document.querySelectorAll('a[href="#"]').forEach(function(el) {
            el.addEventListener('click', function(e) {
                e.preventDefault();
                showToast('해당 기능은 개발 예정입니다');
            });
        });
    });

    /* ========== Chatbot Logic ========== */
    var chatHistory = [];

    function toggleChatbot() {
        var panel = document.getElementById('chatbotPanel');
        var iconOpen = document.getElementById('chatbotIconOpen');
        var iconClose = document.getElementById('chatbotIconClose');
        var isOpen = panel.classList.contains('open');
        if (isOpen) {
            panel.classList.remove('open');
            iconOpen.style.display = '';
            iconClose.style.display = 'none';
        } else {
            panel.classList.add('open');
            iconOpen.style.display = 'none';
            iconClose.style.display = '';
            document.getElementById('chatbotInput').focus();
        }
    }

    function getPageContext() {
        var path = window.location.pathname;
        var context = '';
        if (path.indexOf('/research/catalog') !== -1) {
            var selected = document.querySelector('.compound-row.border-accent');
            if (selected) {
                context = '현재 페이지: Compound Catalog. 선택된 성분: ' + selected.dataset.name +
                    ' (작물: ' + selected.dataset.crop + ', 산지: ' + selected.dataset.origin +
                    ', Score: ' + selected.dataset.score + ', 분류: ' + selected.dataset.class + ')';
            } else {
                context = '현재 페이지: Compound Catalog (성분 미선택)';
            }
        } else if (path.indexOf('/public/dashboard') !== -1) {
            var params = new URLSearchParams(window.location.search);
            context = '현재 페이지: 작목 상세 대시보드. 비교: ' +
                (params.get('crop_a') || '인삼') + ' vs ' + (params.get('crop_b') || '황기');
        } else if (path.indexOf('/research') !== -1) {
            context = '현재 페이지: Research Portal 메인';
        } else if (path.indexOf('/public') !== -1) {
            context = '현재 페이지: Public Portal 메인';
        } else {
            context = '현재 페이지: 랜딩 페이지';
        }
        return context;
    }

    function appendMessage(role, content) {
        var container = document.getElementById('chatbotMessages');
        var div = document.createElement('div');
        div.className = 'chat-msg ' + role;
        div.textContent = content;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
        return div;
    }

    function sendChatMessage() {
        var input = document.getElementById('chatbotInput');
        var text = input.value.trim();
        if (!text) return;

        input.value = '';
        appendMessage('user', text);

        // Add page context to first message or when relevant
        var userMsg = {role: 'user', content: text};
        if (chatHistory.length === 0) {
            userMsg.content = '[컨텍스트: ' + getPageContext() + ']\n\n' + text;
        }
        chatHistory.push(userMsg);

        var loadingDiv = appendMessage('loading', '답변 생성 중...');
        var sendBtn = document.getElementById('chatbotSendBtn');
        sendBtn.disabled = true;

        fetch('/api/chat/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({messages: chatHistory})
        })
        .then(function(res) { return res.json(); })
        .then(function(data) {
            loadingDiv.remove();
            if (data.error) {
                appendMessage('error', 'Error: ' + data.error);
            } else {
                appendMessage('assistant', data.content);
                chatHistory.push({role: 'assistant', content: data.content});
            }
        })
        .catch(function(err) {
            loadingDiv.remove();
            appendMessage('error', '네트워크 오류가 발생했습니다.');
        })
        .finally(function() {
            sendBtn.disabled = false;
        });
    }
    </script>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
